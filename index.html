<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Chalco, inundación</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"
        integrity="sha512-Abr21JO2YqcJ03XGZRPuZSWKBhJpUAR6+2wH5zBeO4wAw4oksr8PRdF+BKIRsxvCdq+Mv4670rZ+dLnIyabbGw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.js"
        integrity="sha512-eYE5o0mD7FFys0tVot8r4AnRXzVVXhjVpzNK+AcHkg4zNLvUAaCOJyLFKjmfpJMj6L/tuCzMN7LULBvNDhy5pA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.2.3.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./css/style.css">
    <script src="./js/script.js"></script>
</head>

<body>

    <h1>Chalco: visualización espacio-temporal de la inundación</h1>

    <div id="map"></div>

    <br>

    <div class="slidecontainer">
        <input type="range" min="0" max="8" value="0" class="slider" id="myrange">
        <p>Mueva la barra para ver las estapas de la inundación.</p>
    </div>

    <script>
        // load a tile layer
        var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        });

        var southWest = L.latLng(19.0, -99.50);
        var northEast = L.latLng(20.0, -98);
        var bounds = L.latLngBounds(southWest, northEast);

        // initialize the map
        var map = L.map('map', {
            minZoom: 14,
            maxZoom: 19,
            maxBounds: [
                //south west
                [18.27, -99.90],
                //north east
                [20.27, -97.90]
            ],
            layers: [osm]
        }).setView([19.27, -98.90], 14);

        var baseMaps = {
            "OpenStreetMap": osm
        };

        $.getJSON("./data/chalco_municipios.geojson", function (munData) {
            L.geoJson(munData, {
                onEachFeature: function (feature, layer) { },
                weight: 3,
                color: "#000000",
                fillOpacity: 0
            }).addTo(map)
        });

        $.getJSON("./data/puntos_bombeo.geojson", function (bombeoData) {
            L.geoJson(bombeoData, {
                pointToLayer: function (feature, latlng) {
                    var marker = L.marker(latlng);
                    marker.bindPopup(
                        'Nombre: ' + feature.properties.Tipo + '<br/>' +
                        'Tipo: ' + feature.properties.tipo_1 + '<br/>' +
                        'Adscripción: ' + feature.properties.adcripció + '<br/>' +
                        'Operando: ' + feature.properties.operando + '<br/>' +
                        'Ubicación: ' + feature.properties.ubicación + '<br/>' +
                        "<strong>Fotografía de bomba o bombeo: </strong>" + "<br>" + "'<a class=\"example-image-link\" href=\"./imgs/bombeo/" + feature.properties.nombre + ".png" + "\" + target=\"_blank\" data-lightbox=\"example-1\"><img class=\"example-image\"  src=\"./imgs/bombeo/" + feature.properties.nombre + ".png" + "\" height=\"150px\" width=\"250px\"/></a>';" + "<br/>"
                    );

                    return marker;
                }
            }).addTo(map)
        });

        let layers = L.layerGroup().addTo(map);

        $.getJSON("./data/chalco_inundacion_00.geojson", function (inundacionData) {
            L.geoJson(inundacionData, {
                onEachFeature: function (feature, layer) { },
                weight: 3,
                color: "#87CEEB",
                fillColor: "#87CEEB",
                fillOpacity: 1
            }).addTo(layers)
        });

        var slider = document.getElementById("myrange");
        var myLayer = document.getElementById("myrange");

        var myFeaturesMap = {};

        var myGeoJsonFeature = {};

        slider.addEventListener("input", function () {

            layers.clearLayers();

            $.getJSON("./data/chalco_inundacion_0" + myLayer.value + ".geojson", function (inundacionData) {

                var geoJsonFeature = inundacionData;

                L.geoJson(geoJsonFeature, {
                    style: style,
                    // onEachFeature: onEachFeature,
                }).addTo(layers);

                function show_geojson() {
                    layers.clearLayers(); // Remove old GeoJSON
                }

                function onEachFeature(feature, layer) {
                    // myFeaturesMap[feature.properties] = geoJsonFeature;
                    layer.on({
                        slidecontainer: highlightFeature,
                        //     mouseout: resetHighlight,
                        //     click: zoomToFeature
                    });
                }
            });

            function getInundacionColor(IdSlider) {
                if (IdSlider == 0)
                    return "#87CEEB";
                if (IdSlider == 1)
                    return "#00BFFF";
                if (IdSlider == 2)
                    return "#1E90FF";
                if (IdSlider == 3)
                    return "#6495Ed";
                if (IdSlider == 4)
                    return "#6495ED";
                if (IdSlider == 5)
                    return "#4169E1";
                if (IdSlider == 6)
                    return "#0000FF";
                if (IdSlider == 7)
                    return "#0000CD";
                if (IdSlider == 8)
                    return "#000080";
                if (IdSlider == 9)
                    return "#191970";
            }

            function style(feature) {
                return {
                    weight: 3,
                    color: getInundacionColor(myLayer.value),
                    fillColor: getInundacionColor(myLayer.value),
                    fillOpacity: 1
                };
            }

            function highlightFeature(e) {
                var layer = e.target;

                info.update(layer.feature.properties);
            }

        });

        $.getJSON("./data/calles_bombeo.geojson", function (callesBombeoData) {
            L.geoJson(callesBombeoData, {
                weight: 4,
                color: "brown",
                fillOpacity: 1,
                onEachFeature: function (feature, layer) {
                    layer.bindPopup(
                        "<strong>Calle </strong>" + feature.properties.Name + "<br/>" +
                        "<strong>Información general: </strong>" + feature.properties.PopupInfo + "<br/><br/>" +
                        "<strong>Perfil de inundación: </strong>" + "<br>" + "'<a class=\"example-image-link\" href=\"" + feature.properties.ruta_foto + "\" + target=\"_blank\" data-lightbox=\"example-1\"><img class=\"example-image\"  src=\"" + feature.properties.ruta_foto + "\" height=\"150px\" width=\"250px\"/></a>';" + "<br/>" +
                        "<i>Haz click en la imagen para verla en una nueva ventana.<i/>"
                    )
                }
            }).addTo(map);
        });

    </script>

</body>

</html>